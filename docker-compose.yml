# Frappe Infrastructure Services
# File ini berisi shared services (MariaDB & Redis) untuk multiple Frappe projects
# Jalankan sekali saja: docker compose -f docker-compose.infrastructure.yml up -d

services:
  # ============================================
  # MARIADB DATABASE
  # ============================================
  mariadb:
    container_name: frappe-mariadb
    image: docker.io/mariadb:11.8
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --skip-character-set-client-handshake
      - --skip-innodb-read-only-compressed
      - --max-connections=500
      - --innodb-buffer-pool-size=1G
    environment:
      # TODO: SECURITY - Ubah password ini untuk production!
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-frappe_root_pass_123}
      MARIADB_AUTO_UPGRADE: 1
    volumes:
      - frappe-mariadb-data:/var/lib/mysql
      # Optional: Mount custom config
      # - ./mariadb-config:/etc/mysql/conf.d
    ports:
      - "3306:3306"
    networks:
      - frappe-network
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_ROOT_PASSWORD:-frappe_root_pass_123}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS CACHE
  # ============================================
  redis-cache:
    container_name: frappe-redis-cache
    image: docker.io/redis:7-alpine
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - frappe-redis-cache-data:/data
    networks:
      - frappe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS QUEUE
  # ============================================
  redis-queue:
    container_name: frappe-redis-queue
    image: docker.io/redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - frappe-redis-queue-data:/data
    networks:
      - frappe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # REDIS SOCKETIO (Optional)
  # ============================================
  redis-socketio:
    container_name: frappe-redis-socketio
    image: docker.io/redis:7-alpine
    volumes:
      - frappe-redis-socketio-data:/data
    networks:
      - frappe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# ============================================
# VOLUMES
# ============================================
volumes:
  frappe-mariadb-data:
    name: frappe-mariadb-data
  frappe-redis-cache-data:
    name: frappe-redis-cache-data
  frappe-redis-queue-data:
    name: frappe-redis-queue-data
  frappe-redis-socketio-data:
    name: frappe-redis-socketio-data

# ============================================
# NETWORKS
# ============================================
networks:
  frappe-network:
    name: frappe-network
    driver: bridge

# ============================================
# USAGE NOTES
# ============================================
#
# START INFRASTRUCTURE:
#   docker compose -f docker-compose.infrastructure.yml up -d
#
# STOP INFRASTRUCTURE:
#   docker compose -f docker-compose.infrastructure.yml down
#
# VIEW LOGS:
#   docker compose -f docker-compose.infrastructure.yml logs -f
#
# BACKUP DATABASE:
#   docker exec frappe-mariadb mysqldump -uroot -p[password] --all-databases > backup.sql
#
# RESTORE DATABASE:
#   docker exec -i frappe-mariadb mysql -uroot -p[password] < backup.sql
#
# REDIS CLI ACCESS:
#   docker exec -it frappe-redis-cache redis-cli
#   docker exec -it frappe-redis-queue redis-cli
#
# DATABASE CLI ACCESS:
#   docker exec -it frappe-mariadb mysql -uroot -p
#
# ============================================
